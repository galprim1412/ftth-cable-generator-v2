name: Build Multi-Platform

on:
  push:
    branches: [ main ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pywin32 pywin32-ctypes
        
    - name: Verify icon file
      run: |
        if (Test-Path "app.ico") {
          Write-Host "✅ Icon file found"
        } else {
          Write-Host "❌ Icon file not found"
          exit 1
        }
        
    - name: Build Windows executable
      run: |
        Write-Host "Current directory: $(Get-Location)"
        Write-Host "Files in current directory:"
        Get-ChildItem
        python build.py
      env:
        PYTHONUNBUFFERED: 1
      
    - name: Upload Windows artifact
      uses: actions/upload-artifact@v4
      with:
        name: windows-executable
        path: dist/EMR Cable Generator.exe
        retention-days: 30

  build-macos:
    runs-on: macos-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Build macOS application
      run: python build.py
      
    - name: Create DMG (optional)
      run: |
        # Create a simple zip for distribution
        cd dist
        zip -r "EMR Cable Generator-macOS.zip" "EMR Cable Generator.app"
        
    - name: Upload macOS artifact
      uses: actions/upload-artifact@v4
      with:
        name: macos-application
        path: dist/EMR Cable Generator-macOS.zip
        retention-days: 30

  build-linux:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Build Linux executable
      run: python build.py
      
    - name: Upload Linux artifact
      uses: actions/upload-artifact@v4
      with:
        name: linux-executable
        path: dist/cable-generator
        retention-days: 30

  create-release:
    needs: [build-windows, build-macos, build-linux]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          windows-executable/EMR Cable Generator.exe
          macos-application/EMR Cable Generator-macOS.zip
          linux-executable/cable-generator
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
